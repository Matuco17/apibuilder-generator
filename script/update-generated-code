#!/usr/bin/env ruby

SERVICE_URL = ARGV.shift || "http://www.apidoc.me"
ORG = "gilt"

def download(service_name, map)
  downloads = {}
  map.each do |target, path|
    tmpfile = "/tmp/download-#{service_name}-#{target}.tmp"
    cmd = "curl --silent #{SERVICE_URL}/#{ORG}/#{service_name}/latest/#{target} > #{tmpfile}"
    puts cmd
    system(cmd)

    contents = IO.read(tmpfile).strip
    if contents == "" || contents.match(/<html>/)
      raise " --> Error downloading URL"
    end

    if `diff #{tmpfile} #{path}`.strip == ""
      puts " --> Unchanged"
    else
      downloads[tmpfile] = path
    end
  end
    
  downloads.each do |tmp, path|
    command = "cp #{tmp} #{path}"
    puts command
    system(command)
  end
end

download("apidoc-spec",
         "play_2_3_client" => "generated/app/ApidocSpecClient.scala"
         )

download("apidoc-generator",
         "play_2_3_client" => "generated/app/ApidocGeneratorClient.scala",
         "play_2_x_routes" => "generator/conf/routes"
         )


